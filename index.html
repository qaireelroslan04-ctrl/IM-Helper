<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group B - Rotation 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        /* Custom Scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        .loader {
            border: 3px solid #374151;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen flex flex-col md:flex-row overflow-hidden">

    <aside class="hidden md:flex flex-col w-64 bg-gray-800 border-r border-gray-700 h-full shadow-xl z-20">
        <div class="p-6 border-b border-gray-700">
            <h1 class="font-bold text-2xl text-blue-400 tracking-tight">Group B</h1>
            <p class="text-xs text-gray-500 mt-1 uppercase tracking-wider">Rotation 2 • Medicine I</p>
        </div>
        
        <div class="flex-1 overflow-y-auto p-4 space-y-2" id="desktopWeekNav">
            </div>

        <div class="p-4 border-t border-gray-700">
             <div id="desktopStatus" class="flex items-center gap-3 bg-gray-900 p-3 rounded-lg text-xs">
                <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse" id="statusDotD"></div>
                <span class="text-gray-400" id="statusTextD">Connecting...</span>
            </div>
            <button onclick="toggleAdmin()" class="w-full mt-3 text-xs text-gray-500 hover:text-white transition">Admin Login</button>
        </div>
    </aside>

    <nav class="md:hidden bg-gray-800 border-b border-gray-700 shadow-md z-50">
        <div class="px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg text-white">Group B</h1>
                <p class="text-[10px] text-gray-400 uppercase">Rotation 2 • Medicine I</p>
            </div>
            <div class="text-xs bg-gray-900 px-3 py-1.5 rounded-full flex items-center gap-2 border border-gray-700">
                <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse" id="statusDotM"></div> 
                <span id="statusTextM">Connecting...</span>
            </div>
        </div>
        <div class="flex gap-2 p-2 overflow-x-auto bg-gray-900 border-t border-gray-800" id="mobileWeekNav">
            </div>
    </nav>

    <main class="flex-1 h-full overflow-y-auto relative bg-gray-900 p-4 md:p-8">
        
        <div class="flex justify-between items-end mb-6 md:mb-8 border-b border-gray-800 pb-4">
            <div>
                <h2 class="text-2xl md:text-3xl font-bold text-white" id="currentWeekTitle">Week 1</h2>
                <p class="text-sm text-gray-400 mt-1" id="dateRangeDisplay">Scheduled Sessions</p>
            </div>
            <div id="adminControls" class="hidden flex gap-3">
                <button onclick="forceReset()" class="bg-red-900/50 text-red-400 px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-900 border border-red-800/50 transition">
                    <i class="fas fa-tools mr-1"></i> Repair DB
                </button>
                <button onclick="openModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-500 shadow-lg transition">
                    <i class="fas fa-plus mr-1"></i> Add Session
                </button>
            </div>
        </div>

        <div id="loading" class="flex flex-col items-center justify-center h-64 text-gray-500">
            <div class="loader mb-4"></div>
            <p class="text-sm">Syncing with database...</p>
            <p class="text-xs mt-2 text-gray-600 max-w-xs text-center">If this takes long, campus WiFi might be blocking the connection.</p>
        </div>
        
        <div id="errorState" class="hidden flex flex-col items-center justify-center h-64 text-red-400">
            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
            <p class="font-bold">Connection Failed</p>
            <p class="text-xs mt-2 text-gray-500 max-w-xs text-center" id="errorDetail">Unknown Error</p>
            <button onclick="location.reload()" class="mt-4 bg-gray-800 px-4 py-2 rounded text-xs hover:bg-gray-700">Retry</button>
        </div>

        <div id="scheduleContainer" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 pb-20">
            </div>

    </main>

    <div id="editModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[60] px-4">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md p-6 shadow-2xl border border-gray-700 transform transition-all">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white" id="modalTitle">Edit Session</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <input type="hidden" id="editId">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Title</label>
                    <input type="text" id="editTitle" class="w-full bg-gray-900 border border-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                </div>
                
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Lecturer</label>
                    <input type="text" id="editLecturer" class="w-full bg-gray-900 border border-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                </div>

                <div class="flex gap-4">
                    <div class="w-1/2">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Date</label>
                        <input type="date" id="editDate" class="w-full bg-gray-900 border border-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    </div>
                    <div class="w-1/2">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Time</label>
                        <input type="text" id="editTime" class="w-full bg-gray-900 border border-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Venue</label>
                    <input type="text" id="editVenue" class="w-full bg-gray-900 border border-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Week</label>
                    <select id="editWeek" class="w-full bg-gray-900 border border-gray-700 text-white p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <option value="1">Week 1</option>
                        <option value="2">Week 2</option>
                        <option value="3">Week 3</option>
                        <option value="4">Week 4</option>
                        <option value="5">Week 5</option>
                        <option value="6">Week 6</option>
                        <option value="7">Week 7</option>
                        <option value="8">Week 8</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button id="deleteBtn" onclick="deleteSession()" class="hidden px-4 py-3 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white rounded-lg transition font-bold text-sm">Delete</button>
                <div class="flex-1"></div>
                <button onclick="closeModal()" class="px-6 py-3 text-gray-400 hover:text-white transition text-sm font-bold">Cancel</button>
                <button onclick="saveSession()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-500 shadow-lg hover:shadow-blue-500/20 transition font-bold text-sm">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // 1. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBd9E9VkE7bllIN13NYGz801F4Jue_VzVk",
            authDomain: "im-helper-d3a4a.firebaseapp.com",
            projectId: "im-helper-d3a4a",
            storageBucket: "im-helper-d3a4a.firebasestorage.app",
            messagingSenderId: "772636018512",
            appId: "1:772636018512:web:b14c28259606e18d6f4e55",
            measurementId: "G-N0F30M6Q5Y"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // --- KEY FIX FOR PERMISSION ERRORS ON WIFI ---
        // This forces standard HTTP polling instead of WebSockets/gRPC which gets blocked by firewalls.
        db.settings({ experimentalForceLongPolling: true });
        
        const scheduleRef = db.collection("schedule_group_b");

        let currentWeek = 1;
        let isAdmin = false;
        let allEvents = [];

        // 2. SEED DATA
        const seedData = [
            // WEEK 1
            { title: "Briefing & Intro", lecturer: "Dr Affizal", date: "2025-12-22", time: "09:00 AM", venue: "Online", week: 1, type: "Lecture" },
            { title: "Gastro Intro", lecturer: "Dr Affizal", date: "2025-12-22", time: "TBC (AM)", venue: "Online", week: 1, type: "Lecture" },
            { title: "Cardio Intro", lecturer: "AP Dr Ling HS", date: "2025-12-22", time: "TBC (PM)", venue: "Online", week: 1, type: "Lecture" },
            { title: "Endocrine Intro", lecturer: "AP Dr Loh HH", date: "2025-12-23", time: "TBC (AM)", venue: "Online", week: 1, type: "Lecture" },
            { title: "Respiratory Intro", lecturer: "AP Dr Chai CS", date: "2025-12-23", time: "TBC (PM)", venue: "Online", week: 1, type: "Lecture" },
            { title: "Neurology Intro", lecturer: "AP Dr Sim CY", date: "2025-12-26", time: "TBC (AM)", venue: "Online", week: 1, type: "Lecture" },
            // WEEK 2
            { title: "Cardio Lecture (LHS 2)", lecturer: "AP Dr Ling HS", date: "2025-12-29", time: "08:00 AM", venue: "TBC", week: 2, type: "Lecture" },
            { title: "BST (PJS) Session", lecturer: "AP Dr Ling HS (B LHS 4)", date: "2025-12-29", time: "TBC (AM)", venue: "PJS", week: 2, type: "BST" },
            { title: "BST (SGH) Session", lecturer: "Prof Dr Henry G (B HG 1)", date: "2025-12-30", time: "TBC (AM)", venue: "SGH", week: 2, type: "BST" },
            { title: "Combined BST (PJS)", lecturer: "Dr Chow HB (AB CHB 2)", date: "2026-01-02", time: "TBC (AM)", venue: "PJS", week: 2, type: "BST" },
            { title: "Resp Seminar", lecturer: "AP Dr Chai CS", date: "2026-01-02", time: "TBC (AM)", venue: "TBC", week: 2, type: "Seminar" },
            { title: "Resp Lecture", lecturer: "AP Dr Chai CS", date: "2026-01-02", time: "TBC (PM)", venue: "TBC", week: 2, type: "Lecture" },
            // WEEK 3
            { title: "BST (PJS)", lecturer: "AP Dr Loh HH (B LHH 3)", date: "2026-01-05", time: "TBC (AM)", venue: "PJS", week: 3, type: "BST" },
            { title: "Case Discussion", lecturer: "Dr Chan EZ (AB CEZ 2)", date: "2026-01-05", time: "TBC (PM)", venue: "TBC", week: 3, type: "CD" },
            { title: "BST (SGH)", lecturer: "AP Dr Loh HH (B LHH 3)", date: "2026-01-06", time: "TBC (AM)", venue: "SGH", week: 3, type: "BST" },
            { title: "Gastro Lecture", lecturer: "Dr Affizal (AF 3)", date: "2026-01-06", time: "TBC (PM)", venue: "TBC", week: 3, type: "Lecture" },
            { title: "BST (SGH)", lecturer: "Dr Joshua (B JOSHUA 2)", date: "2026-01-07", time: "TBC (AM)", venue: "SGH", week: 3, type: "BST" },
            { title: "Gastro Seminar", lecturer: "Dr Affizal (AF 4)", date: "2026-01-07", time: "TBC (PM)", venue: "TBC", week: 3, type: "Seminar" },
            { title: "BST (PJS)", lecturer: "Dr Yeoh CW (B YEOH 1)", date: "2026-01-08", time: "TBC (AM)", venue: "PJS", week: 3, type: "BST" },
            { title: "Inf. Disease Lecture", lecturer: "AP Dr Diana Ng", date: "2026-01-08", time: "TBC (PM)", venue: "TBC", week: 3, type: "Lecture" },
            { title: "Combined Case Disc", lecturer: "Dr Affizal (BE AF 5)", date: "2026-01-09", time: "TBC (PM)", venue: "TBC", week: 3, type: "CD" }
        ];

        // 3. LISTENERS
        function updateStatus(status, msg) {
            const color = status === 'ok' ? 'bg-green-500' : 'bg-red-500';
            const animate = status === 'ok' ? '' : 'animate-pulse';
            
            // Update Mobile
            const dotM = document.getElementById('statusDotM');
            dotM.className = `w-2 h-2 rounded-full ${color} ${animate}`;
            document.getElementById('statusTextM').innerText = msg;

            // Update Desktop
            const dotD = document.getElementById('statusDotD');
            dotD.className = `w-2 h-2 rounded-full ${color} ${animate}`;
            document.getElementById('statusTextD').innerText = msg;
        }

        scheduleRef.orderBy("date").orderBy("time").onSnapshot((snapshot) => {
            updateStatus('ok', 'Live');
            allEvents = [];
            snapshot.forEach((doc) => {
                allEvents.push({ id: doc.id, ...doc.data() });
            });
            renderSchedule();
        }, (error) => {
            console.error(error);
            updateStatus('err', 'Error');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorDetail').innerText = error.message;
        });

        // 4. RENDER
        function renderSchedule() {
            const container = document.getElementById('scheduleContainer');
            const loader = document.getElementById('loading');
            
            loader.classList.add('hidden');
            container.classList.remove('hidden');
            container.innerHTML = '';

            const weekEvents = allEvents.filter(e => e.week == currentWeek);

            if (weekEvents.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center p-12 text-gray-600 bg-gray-800/50 rounded-2xl border border-gray-800 border-dashed">
                        <i class="fas fa-mug-hot text-4xl mb-4 text-gray-700"></i>
                        <p class="font-medium">No sessions scheduled for Week ${currentWeek}</p>
                        ${isAdmin ? '<p class="text-xs text-blue-500 mt-2">Use "Repair DB" to upload defaults.</p>' : ''}
                    </div>`;
                return;
            }

            // Group by Date
            const grouped = {};
            weekEvents.forEach(event => {
                if (!grouped[event.date]) grouped[event.date] = [];
                grouped[event.date].push(event);
            });

            // Iterate through dates
            Object.keys(grouped).sort().forEach(date => {
                const dateObj = new Date(date);
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
                const dateNum = dateObj.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                
                // Add Date Header within Grid (Spans full width)
                container.innerHTML += `
                    <div class="col-span-full flex items-center gap-4 mt-4 mb-2">
                        <div class="h-px bg-gray-700 flex-1"></div>
                        <div class="text-blue-400 font-bold uppercase tracking-wider text-xs">${dayName} <span class="text-gray-500 ml-1">${dateNum}</span></div>
                        <div class="h-px bg-gray-700 flex-1"></div>
                    </div>
                `;

                // Add Cards
                grouped[date].forEach(event => {
                    const isPending = event.time.includes("TBC") || event.venue === "N/A" || event.venue === "TBC";
                    const statusBorder = isPending ? "border-l-4 border-yellow-500" : "border-l-4 border-green-500";
                    const bgClass = isPending ? "bg-gray-800/80" : "bg-gray-800";
                    
                    const html = `
                        <div class="group relative ${bgClass} rounded-xl shadow-lg hover:shadow-2xl hover:bg-gray-750 transition-all duration-300 overflow-hidden cursor-pointer border border-gray-700/50 ${statusBorder}" onclick="handleCardClick('${event.id}')">
                            <div class="p-5">
                                <div class="flex justify-between items-start mb-3">
                                    <span class="text-[10px] font-extrabold uppercase px-2 py-1 rounded bg-gray-900 text-gray-300 tracking-wide border border-gray-700">${event.type}</span>
                                    ${isPending ? '<span class="text-[10px] text-yellow-500 font-bold flex items-center gap-1"><i class="fas fa-exclamation-circle"></i> TBC</span>' : ''}
                                </div>
                                
                                <h3 class="font-bold text-white text-lg leading-tight mb-1 group-hover:text-blue-400 transition-colors">${event.title}</h3>
                                <p class="text-xs text-gray-400 font-medium mb-4">${event.lecturer}</p>
                                
                                <div class="space-y-2 text-sm text-gray-300 border-t border-gray-700/50 pt-3">
                                    <div class="flex items-center gap-3">
                                        <i class="far fa-clock text-blue-500 w-4 text-center"></i> 
                                        <span>${event.time}</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <i class="fas fa-map-marker-alt text-red-500 w-4 text-center"></i> 
                                        <span>${event.venue}</span>
                                    </div>
                                </div>
                            </div>
                            ${isAdmin ? '<div class="absolute top-4 right-4 text-gray-600 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-pen"></i></div>' : ''}
                        </div>
                    `;
                    container.innerHTML += html;
                });
            });
        }

        // 5. ADMIN & REPAIR
        function toggleAdmin() {
            if (isAdmin) {
                isAdmin = false;
                document.getElementById('adminControls').classList.add('hidden');
                document.querySelector('aside button').innerText = "Admin Login";
                renderSchedule();
            } else {
                const pass = prompt("Passcode:");
                if (pass === "admin123") {
                    isAdmin = true;
                    document.getElementById('adminControls').classList.remove('hidden');
                    document.querySelector('aside button').innerText = "Logout";
                    renderSchedule();
                } else { alert("Wrong passcode"); }
            }
        }

        async function forceReset() {
            if(!confirm("⚠️ This will WIPE and RE-UPLOAD the default schedule. Are you sure?")) return;
            
            const batch = db.batch();
            
            // Delete existing (simplified: just adds new ones for now to avoid complexity)
            // Ideally we delete, but batch writes are easier.
            
            seedData.forEach((docData) => {
                const newRef = scheduleRef.doc();
                batch.set(newRef, docData);
            });
            
            try {
                await batch.commit();
                alert("Database Repaired! The page will now reload.");
                location.reload(); // Force reload to fetch fresh data
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        // 6. UI & NAVIGATION
        function initNav() {
            const mobileContainer = document.getElementById('mobileWeekNav');
            const desktopContainer = document.getElementById('desktopWeekNav');
            
            // Clear
            mobileContainer.innerHTML = '';
            desktopContainer.innerHTML = '';

            for (let i = 1; i <= 8; i++) {
                // Mobile Button
                const btnM = document.createElement('button');
                btnM.innerText = `W${i}`;
                btnM.className = `flex-shrink-0 w-10 h-10 rounded-full text-xs font-bold transition ${i === 1 ? 'bg-blue-600 text-white shadow-lg shadow-blue-900' : 'bg-gray-800 text-gray-400 border border-gray-700'}`;
                btnM.onclick = () => setWeek(i);
                btnM.id = `navM_${i}`;
                mobileContainer.appendChild(btnM);

                // Desktop Button
                const btnD = document.createElement('button');
                btnD.innerHTML = `<span class="opacity-50">Week</span> ${i}`;
                btnD.className = `w-full text-left px-4 py-3 rounded-lg text-sm font-bold transition flex justify-between items-center ${i === 1 ? 'bg-blue-600 text-white shadow-lg' : 'text-gray-400 hover:bg-gray-700/50'}`;
                btnD.onclick = () => setWeek(i);
                btnD.id = `navD_${i}`;
                desktopContainer.appendChild(btnD);
            }
        }

        function setWeek(week) {
            currentWeek = week;
            document.getElementById('currentWeekTitle').innerText = `Week ${week}`;
            renderSchedule();
            
            // Update Styles
            for (let i = 1; i <= 8; i++) {
                const m = document.getElementById(`navM_${i}`);
                const d = document.getElementById(`navD_${i}`);
                
                if (i === week) {
                    m.className = `flex-shrink-0 w-10 h-10 rounded-full text-xs font-bold transition bg-blue-600 text-white shadow-lg shadow-blue-900`;
                    d.className = `w-full text-left px-4 py-3 rounded-lg text-sm font-bold transition flex justify-between items-center bg-blue-600 text-white shadow-lg`;
                } else {
                    m.className = `flex-shrink-0 w-10 h-10 rounded-full text-xs font-bold transition bg-gray-800 text-gray-400 border border-gray-700`;
                    d.className = `w-full text-left px-4 py-3 rounded-lg text-sm font-bold transition flex justify-between items-center text-gray-400 hover:bg-gray-700/50`;
                }
            }
        }

        // 7. MODAL LOGIC
        function handleCardClick(id) {
            if (!isAdmin) return;
            const event = allEvents.find(e => e.id === id);
            openModal(event);
        }

        function openModal(event = null) {
            document.getElementById('editModal').classList.remove('hidden');
            if (event) {
                document.getElementById('modalTitle').innerText = "Edit Session";
                document.getElementById('editId').value = event.id;
                document.getElementById('editTitle').value = event.title;
                document.getElementById('editLecturer').value = event.lecturer;
                document.getElementById('editDate').value = event.date;
                document.getElementById('editTime').value = event.time;
                document.getElementById('editVenue').value = event.venue;
                document.getElementById('editWeek').value = event.week;
                document.getElementById('deleteBtn').classList.remove('hidden');
            } else {
                document.getElementById('modalTitle').innerText = "New Session";
                document.getElementById('editId').value = "";
                document.getElementById('editTitle').value = "";
                document.getElementById('editLecturer').value = "";
                document.getElementById('editDate').value = "";
                document.getElementById('editTime').value = "TBC";
                document.getElementById('editVenue').value = "TBC";
                document.getElementById('editWeek').value = currentWeek;
                document.getElementById('deleteBtn').classList.add('hidden');
            }
        }

        function closeModal() { document.getElementById('editModal').classList.add('hidden'); }

        function saveSession() {
            const id = document.getElementById('editId').value;
            const data = {
                title: document.getElementById('editTitle').value,
                lecturer: document.getElementById('editLecturer').value,
                date: document.getElementById('editDate').value,
                time: document.getElementById('editTime').value,
                venue: document.getElementById('editVenue').value,
                week: document.getElementById('editWeek').value,
                type: "Custom"
            };

            if (id) {
                scheduleRef.doc(id).update(data).then(closeModal);
            } else {
                scheduleRef.add(data).then(closeModal);
            }
        }

        function deleteSession() {
            const id = document.getElementById('editId').value;
            if(confirm("Delete this session?")) {
                scheduleRef.doc(id).delete().then(closeModal);
            }
        }

        // Init
        initNav();
        setWeek(1);

    </script>
</body>
</html>
