<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Internal Medicine Timetable</title>

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg-body: #000000; --bg-sidebar: #050505; --bg-card: #0a0a0a;
            --bg-box: #111111; --bg-input: #171717; --border-color: #27272a;
            --text-main: #e2e8f0; --text-muted: #94a3b8; --accent-color: #3b82f6;
            --accent-bg: #172554; --accent-text: #bfdbfe; --header-bg: rgba(0, 0, 0, 0.85);
            --status-yellow: #d97706; --whatsapp-color: #25D366; --whatsapp-bg: #064e23;
        }

        [data-theme="light"] {
            --bg-body: #f0f4f8; --bg-sidebar: #ffffff; --bg-card: #ffffff;
            --bg-box: #f8fafc; --bg-input: #f1f5f9; --border-color: #e2e8f0;
            --text-main: #1e293b; --text-muted: #64748b; --accent-color: #0284c7;
            --accent-bg: #e0f2fe; --accent-text: #0c4a6e; --header-bg: rgba(255, 255, 255, 0.95);
            --whatsapp-bg: #dcfce7;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }

        header {
            background-color: var(--header-bg); backdrop-filter: blur(12px);
            padding: 0 1.5rem; padding-top: env(safe-area-inset-top);
            height: calc(60px + env(safe-area-inset-top));
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color); z-index: 50; flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; gap: 1rem; flex: 1; overflow: hidden; }
        .menu-toggle { background: none; border: none; color: var(--text-main); font-size: 1.5rem; cursor: pointer; }
        .app-title { font-size: 1.15rem; font-weight: 800; color: var(--accent-color); white-space: nowrap; }
        .week-badge { font-size: 0.7rem; background: var(--bg-input); padding: 2px 8px; border-radius: 4px; border: 1px solid var(--border-color); color: var(--text-muted); font-weight: 700; }
        .theme-toggle { background: none; border: 1px solid var(--border-color); color: var(--text-main); cursor: pointer; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        .main-container { flex: 1; display: flex; overflow: hidden; position: relative; }

        aside {
            width: 320px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; z-index: 999; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* APPLE SAFE AREA FIX */
        .nav-header { padding: 1.2rem 1rem; padding-top: calc(1rem + env(safe-area-inset-top)); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .view-toggle { display: flex; background: var(--bg-input); padding: 4px; border-radius: 12px; gap: 4px; }
        .toggle-btn { flex: 1; background: transparent; border: none; color: var(--text-muted); padding: 10px 2px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; cursor: pointer; border-radius: 8px; transition: 0.2s; }
        .toggle-btn.active { background: var(--accent-color); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .nav-scroll-area { flex: 1; overflow-y: auto; overscroll-behavior: contain; }
        .nav-item { padding: 1.2rem 1.5rem; cursor: pointer; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .nav-item.active { background: var(--accent-bg); border-left: 4px solid var(--accent-color); }
        .nav-item .nav-title { font-weight: 700; font-size: 0.9rem; }

        .sidebar-footer { flex-shrink: 0; padding: 1rem; border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 8px; padding-bottom: calc(1rem + env(safe-area-inset-bottom)); }
        .footer-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); padding: 0.6rem; border-radius: 0.5rem; font-size: 0.75rem; cursor: pointer; font-weight: 600; text-align: center; }

        main { flex: 1; overflow-y: auto; padding: 1rem; scroll-behavior: smooth; padding-bottom: 120px; }
        .day-group { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 8px solid var(--bg-input); scroll-margin-top: 80px; }
        .day-header { padding: 1rem 0 0.5rem 0; display: flex; align-items: baseline; gap: 0.5rem; }
        .day-name { font-size: 1.5rem; font-weight: 800; color: var(--text-main); text-transform: uppercase; }
        .day-date { font-size: 0.85rem; color: var(--text-muted); }

        .class-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.25rem; margin-bottom: 1rem; cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden; display: flex; gap: 1rem; }
        .class-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--border-color); }
        .class-card.type-BST::before { background: #8b5cf6; }
        .class-card.type-Lecture::before { background: #3b82f6; }
        .class-card.type-Seminar::before { background: #f97316; }
        .class-card.type-Case::before { background: #10b981; }
        .class-card.type-Exam::before { background: #ef4444; }

        .time-col { display: flex; flex-direction: column; align-items: center; min-width: 60px; padding-right: 1rem; border-right: 1px solid var(--border-color); }
        .time-start { font-weight: 800; font-size: 1rem; color: var(--text-main); }
        .time-ampm { font-size: 0.7rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
        .info-col { flex: 1; }
        .card-type { font-size: 0.65rem; text-transform: uppercase; font-weight: 700; background: var(--bg-input); color: var(--text-muted); padding: 2px 6px; border-radius: 4px; }
        .card-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); margin: 0.25rem 0; }
        .card-meta { font-size: 0.85rem; color: var(--text-muted); }
        .tbc-alert { color: var(--status-yellow); font-size: 0.7rem; font-weight: 800; display: flex; align-items: center; gap: 4px; margin-top: 4px; }

        .next-week-container { padding: 2rem 0; text-align: center; }
        .btn-next-week { background-color: var(--bg-input); color: var(--accent-color); border: 1px solid var(--border-color); padding: 1rem 2rem; border-radius: 2rem; font-weight: 700; cursor: pointer; width: 100%; max-width: 300px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .detail-sheet { background: var(--bg-card); width: calc(100% - 24px); max-width: 600px; max-height: 85vh; border-radius: 1.5rem; position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%) translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal-overlay.active .detail-sheet { transform: translateX(-50%) translateY(0); }

        @media(min-width: 768px) { .detail-sheet { position: relative; bottom: auto; left: auto; transform: scale(0.95); opacity: 0; } .modal-overlay.active .detail-sheet { transform: scale(1); opacity: 1; } }

        .sheet-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: start; background: var(--bg-box); }
        .sheet-close { background: var(--bg-input); border: none; width: 32px; height: 32px; border-radius: 50%; color: var(--text-main); cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .sheet-body { flex: 1; overflow-y: auto; padding: 1.5rem; padding-bottom: calc(1.5rem + env(safe-area-inset-bottom)); }

        .detail-row { margin-bottom: 1.5rem; }
        .detail-label { font-size: 0.75rem; text-transform: uppercase; color: var(--accent-color); font-weight: 700; margin-bottom: 0.5rem; }
        .detail-value { font-size: 1.1rem; }
        .detail-note { background: var(--bg-input); padding: 1rem; border-radius: 0.5rem; border-left: 3px solid var(--accent-color); font-size: 0.95rem; }

        .btn-whatsapp { background-color: var(--whatsapp-bg); color: var(--whatsapp-color); border: 1px solid var(--whatsapp-color); padding: 0.8rem; border-radius: 0.5rem; font-weight: 700; cursor: pointer; text-align: center; text-decoration: none; display: flex; align-items: center; justify-content: center; margin-top: 1rem; }
        .presenter-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px dashed var(--border-color); }
        .presenter-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .presenter-tag { background: var(--accent-bg); color: var(--accent-text); padding: 6px 12px; border-radius: 1rem; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: 1px solid var(--accent-color); }

        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.4rem; }
        .form-input, .form-select { width: 100%; padding: 0.8rem; background: var(--bg-input); border: 1px solid var(--border-color); color: var(--text-main); border-radius: 0.5rem; outline: none; font-size: 1rem; }
        .btn { padding: 0.8rem 1.5rem; border-radius: 0.5rem; font-weight: 700; border: none; cursor: pointer; width: 100%; margin-top: 1rem; }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-danger { background: rgba(220, 38, 38, 0.1); color: #ef4444; border: 1px solid #ef4444; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border-color); }
        .hidden { display: none; }

        .fab { position: fixed; bottom: calc(2rem + env(safe-area-inset-bottom)); right: 2rem; width: 56px; height: 56px; background: var(--accent-color); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; z-index: 90; font-size: 1.5rem; }
        .backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 35; backdrop-filter: blur(5px); }
        @media (max-width: 768px) {
            .menu-toggle { display: block; }
            aside { position: fixed; top: 0; left: 0; height: 100dvh; transform: translateX(-100%); }
            aside.open { transform: translateX(0); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            .backdrop.open { display: block; }
        }

        .analytics-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .analytics-header { display: flex; align-items: center; gap: 1.5rem; }
        .chart-wrapper { position: relative; width: 80px; height: 80px; flex-shrink: 0; }
        .pie-chart { width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(var(--accent-color) 0% 0%, var(--bg-input) 0% 100%); display: flex; align-items: center; justify-content: center; }
        .pie-inner { width: 80%; height: 80%; background: var(--bg-card); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.9rem; color: var(--text-main); }
        .analytics-info { flex: 1; }
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.8rem; width: 100%; }
        .stat-box { background: var(--bg-input); padding: 0.8rem; border-radius: 0.8rem; border: 1px solid var(--border-color); text-align: center; }
        .stat-num { font-size: 1.2rem; font-weight: 800; color: var(--text-main); display: block; }
        .stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; font-weight: 700; margin-top: 4px; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <button class="menu-toggle" onclick="toggleSidebar(true)">â˜°</button>
            <h1 class="app-title" id="mainHeaderTitle">Internal Medicine</h1>
            <span class="week-badge" id="currentWeekBadge">Week 1</span>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>
    </header>

    <div class="main-container">
        <div class="backdrop" id="backdrop" onclick="toggleSidebar(false)"></div>
        <aside id="sidebar">
            <div class="nav-header">
                <div class="view-toggle">
                    <button id="btnViewWeek" class="toggle-btn active" onclick="switchView('week')">Week</button>
                    <button id="btnViewLecturer" class="toggle-btn" onclick="switchView('lecturer')">Lecturer</button>
                    <button id="btnViewMember" class="toggle-btn" onclick="switchView('member')">Member</button>
                    <button id="btnViewReminder" class="toggle-btn" onclick="switchView('reminder')">ðŸ””</button>
                </div>
            </div>
            <div id="weekList" class="nav-scroll-area"></div>
            <div class="sidebar-footer">
                <button onclick="toggleNotifications()" id="notifyBtn" class="footer-btn">ðŸ”” Reminders: Off</button>
                <button onclick="adminLogin()" id="adminBtn" class="footer-btn">Admin Login</button>
            </div>
        </aside>
        <main id="scheduleContainer"><div style="text-align: center; padding-top: 5rem; color: var(--text-muted);">Loading Schedule...</div></main>
    </div>

    <div id="fabBtn" class="fab" onclick="openEditModal()">+</div>

    <div id="detailModal" class="modal-overlay">
        <div class="detail-sheet">
            <div class="sheet-header">
                <div><span class="card-type" id="detailType">SESSION</span><h2 style="margin-top: 0.5rem; font-size: 1.5rem;" id="detailTitle">Title</h2></div>
                <button class="sheet-close" onclick="closeModal('detailModal')">Ã—</button>
            </div>
            <div class="sheet-body">
                <div class="detail-row"><div class="detail-label">Time & Date</div><div class="detail-value" id="detailTime"></div></div>
                <div class="detail-row"><div class="detail-label">Lecturer</div><div class="detail-value" id="detailLecturer"></div></div>
                <div class="detail-row"><div class="detail-label">Venue</div><div class="detail-value" id="detailVenue"></div></div>
                <div class="detail-row"><div class="detail-label">Notes</div><div class="detail-note" id="detailNotes"></div></div>
                <div id="contactSection" class="btn-group hidden"></div>
                <div id="presenterSection" class="presenter-section hidden">
                    <div class="detail-label">Presenting</div>
                    <div id="presenterList" class="presenter-list"></div>
                    <button class="btn btn-primary" onclick="openPresentForm()" style="margin-top: 1rem;">I'm Presenting</button>
                </div>
                <button id="editBtn" class="hidden btn btn-ghost" style="margin-top:1rem" onclick="editCurrentClass()">Edit Class (Admin)</button>
            </div>
        </div>
    </div>

    <div id="presentFormModal" class="modal-overlay">
        <div class="detail-sheet">
            <div class="sheet-header"><h2 id="presentFormTitle">Presentation Spot</h2><button class="sheet-close" onclick="closeModal('presentFormModal')">Ã—</button></div>
            <div class="sheet-body">
                <input type="hidden" id="editPresenterId">
                <div class="form-group">
                    <label class="form-label">Name (Required)</label>
                    <select id="inpPresName" class="form-select">
                        <option value="">Choose Name...</option>
                        <option value="Aina">Aina</option><option value="Amy">Amy</option><option value="Clarissa">Clarissa</option>
                        <option value="Danisha">Danisha</option><option value="Qaireel">Qaireel</option><option value="Sashmitha">Sashmitha</option>
                        <option value="Xin Ee">Xin Ee</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Case Name (Optional)</label><input type="text" id="inpPresCase" class="form-input"></div>
                <div class="form-group"><label class="form-label">Key Details (Optional)</label><textarea id="inpPresDetail" class="form-input" rows="4"></textarea></div>
                <button onclick="submitPresentation()" class="btn btn-primary">Save Info</button>
            </div>
        </div>
    </div>

    <div id="viewPresenterModal" class="modal-overlay">
        <div class="detail-sheet">
            <div class="sheet-header"><h2 id="viewPresName">Presenter</h2><button class="sheet-close" onclick="closeModal('viewPresenterModal')">Ã—</button></div>
            <div class="sheet-body">
                <div class="detail-row"><div class="detail-label">Case Name</div><div class="detail-value" id="viewPresCase"></div></div>
                <div class="detail-row"><div class="detail-label">Details</div><div class="detail-note" id="viewPresDetail"></div></div>
                <div class="btn-group" style="display:flex; gap:10px; flex-direction:row">
                    <button class="btn btn-primary" style="flex:1" onclick="openEditPresenter()">Edit</button>
                    <button class="btn btn-danger" style="flex:1" onclick="deletePresentation()">Remove</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="detail-sheet">
            <div class="sheet-header"><h2>Manage Session</h2><button class="sheet-close" onclick="closeModal('editModal')">Ã—</button></div>
            <div class="sheet-body">
                <input type="hidden" id="editId">
                <div class="form-group"><label class="form-label">Type</label>
                    <select id="inpType" class="form-select" onchange="toggleTimeInputs()">
                        <option value="Lecture">Lecture</option>
                        <option value="BST">BST</option>
                        <option value="Case Discussion">Case Discussion</option>
                        <option value="Seminar">Seminar</option>
                        <option value="Exam">Exam</option>
                        <option value="Reminder">Reminder</option> <option value="Custom">Other</option>
                    </select>   
                </div>
                <div class="form-group"><label class="form-label">Title</label><input type="text" id="inpTitle" class="form-input"></div>
                <div class="form-group"><label class="form-label">Lecturer</label><select id="inpLecturerSelect" class="form-select" onchange="checkLecturerSelect()"></select><div id="divOtherLecturer" class="hidden"><input type="text" id="inpLecturerText" class="form-input" style="margin-top:0.5rem"></div><input type="tel" id="inpLecturerPhone" class="form-input" placeholder="Phone" style="margin-top:0.5rem"></div>
                <div class="form-group"><label class="form-label">Date</label><input type="date" id="inpDate" class="form-input"></div>
                <div class="form-group time-row"><div class="time-block"><label class="form-label">Start</label><input type="time" id="inpStartTime" class="form-input"></div><div class="time-block"><label class="form-label">End</label><input type="time" id="inpEndTime" class="form-input"></div></div>
                <div class="form-group"><label class="form-label">Venue</label><input type="text" id="inpVenue" class="form-input"></div>
                <div class="form-group"><label class="form-label">Week</label><select id="inpWeek" class="form-select"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option></select></div>
                <div class="form-group"><label class="form-label">Notes</label><textarea id="inpNotes" class="form-input"></textarea></div>
                <button onclick="saveClass()" class="btn btn-primary">Save Changes</button>
                <button onclick="deleteClass()" id="btnDelete" class="hidden btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyA8rnosiofoyiDPXKDrOAEyp82vVyefYkU", authDomain: "im-helper-d3a4a.firebaseapp.com", projectId: "im-helper-d3a4a", storageBucket: "im-helper-d3a4a.firebasestorage.app", messagingSenderId: "772636018512", appId: "1:772636018512:web:b14c28259606e18d6f4e55" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const scheduleRef = db.collection("schedule_group_b");
        const auth = firebase.auth();
        const googleProvider = new firebase.auth.GoogleAuthProvider();
        const allowedAdminEmail = "qaireelroslan04@gmail.com";

        // Listen for login state changes (Handles "Remember Me")
        auth.onAuthStateChanged(user => {
            if (user && user.email === allowedAdminEmail) {
                isAdmin = true;
                // Update UI for Admin
                document.getElementById('fabBtn').style.display = 'flex';
                document.getElementById('adminBtn').innerText = "Logout";
                // If a card is open, show the edit button immediately
                if(currentDetailId) document.getElementById('editBtn').classList.remove('hidden');
                console.log("Admin logged in as: " + user.email);
            } else {
                isAdmin = false;
                // Hide Admin UI
                document.getElementById('fabBtn').style.display = 'none';
                document.getElementById('adminBtn').innerText = "Admin Login";
                if(currentDetailId) document.getElementById('editBtn').classList.add('hidden');
                
            }
            if (!user) auth.signInAnonymously().catch(console.error);
        });

        const lecturerContacts = { "Dr Affizal Samsudin": "60176631789", "Dr Asri B Said": "60138021143", "Dr Chai Chee Shee": "60198188265", "Dr Chan En Ze": "60105054955", "Dr Chow Han Bing": "60192712889", "Dr Diana Ng": "60198198265", "Dr Frederick De Rozario": "60168678252", "Dr Henry Gudum": "60198895047", "Dr Joshua Chung": "60168963966", "Dr Kuan Jew Win": "60198593011", "Dr Ling Hwei Sung": "60128939596", "Dr Loh Huai Heng": "60122010765", "Dr Sim Chun Yang": "60138273338", "Dr Sim Sing Yee": "60138338862", "Dr Yeoh Cheng Wooi": "60182628290" };
        const lecturers = Object.keys(lecturerContacts).sort(); lecturers.push("Other");
        const groupMembers = ["Aina", "Amy", "Clarissa", "Danisha", "Qaireel", "Sashmitha", "Xin Ee"];

        let allEvents = [], currentWeek = 1, viewMode = 'week', currentLecturer = null, currentMember = null, isAdmin = false, currentDetailId = null, currentPresIndex = null;
        let isNotifyEnabled = localStorage.getItem('notifications') === 'true';

        // EDITED: Added client-side sorting to fix AM/PM ordering
        scheduleRef.orderBy("date").onSnapshot(s => {
            allEvents = s.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Sort logic: First by Date, then by Time (using the helper to parse AM/PM)
            allEvents.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return getMinutes(a.time) - getMinutes(b.time);
            });
        
            renderSidebarNav(); renderSchedule();
            if(currentDetailId) openDetail(currentDetailId);
        });

        function toggleTimeInputs() {
            const type = document.getElementById('inpType').value;
            const isReminder = type === 'Reminder';
            // Hide/Show time inputs and Venue based on type
            document.querySelector('.time-row').style.display = isReminder ? 'none' : 'flex';
            document.getElementById('inpVenue').closest('.form-group').style.display = isReminder ? 'none' : 'block';
            
            // Auto-fill venue/lecturer for reminders to keep DB clean
            if(isReminder) {
                document.getElementById('inpVenue').value = 'Reminder';
                document.getElementById('inpLecturerSelect').value = 'Other';
                document.getElementById('inpLecturerText').value = 'System';
                document.getElementById('divOtherLecturer').classList.add('hidden');
            }
        }

        function switchView(m) { 
            viewMode = m; 
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.toggle('active', b.id === 'btnView' + m.charAt(0).toUpperCase() + m.slice(1)));
            // Sidebar stays open as requested
            renderSidebarNav(); renderSchedule(); 
        }
        function toggleSidebar(f) { const s=document.getElementById('sidebar'), b=document.getElementById('backdrop'); if(f===true){s.classList.add('open');b.classList.add('open');}else if(f===false){s.classList.remove('open');b.classList.remove('open');}else{s.classList.toggle('open');b.classList.toggle('open');} }
        function calculateCurrentWeek() { const s=new Date('2025-12-22T00:00:00'), t=new Date(); return t<s?1:Math.min(8, Math.ceil(Math.ceil(Math.abs(t-s)/(1000*60*60*24))/7)); }

        function renderSidebarNav() {
            const list = document.getElementById('weekList'); list.innerHTML = '';
            
            if (viewMode === 'week') {
                for(let i=1; i<=8; i++) {
                    const div = document.createElement('div'); div.className = `nav-item ${i === currentWeek ? 'active' : ''}`;
                    div.onclick = () => { currentWeek = i; toggleSidebar(false); renderSidebarNav(); renderSchedule(); };
                    div.innerHTML = `<div class="nav-title">Week ${i}</div>`; list.appendChild(div);
                }
                document.getElementById('currentWeekBadge').innerText = `Week ${currentWeek}`;
            
            } else if (viewMode === 'lecturer') {
                const names = new Set(Object.keys(lecturerContacts)); allEvents.forEach(e => { if(e.lecturer) names.add(e.lecturer); });
                Array.from(names).sort().forEach(n => {
                    const div = document.createElement('div'); div.className = `nav-item ${n === currentLecturer ? 'active' : ''}`;
                    div.onclick = () => { currentLecturer = n; toggleSidebar(false); renderSidebarNav(); renderSchedule(); };
                    div.innerHTML = `<div class="nav-title">${n}</div>`; list.appendChild(div);
                });
                document.getElementById('currentWeekBadge').innerText = "Lecturer";
            
            } else if (viewMode === 'member') { // <--- CHANGED FROM 'else' TO 'else if'
                groupMembers.forEach(n => {
                    const div = document.createElement('div'); div.className = `nav-item ${n === currentMember ? 'active' : ''}`;
                    div.onclick = () => { currentMember = n; toggleSidebar(false); renderSidebarNav(); renderSchedule(); };
                    div.innerHTML = `<div class="nav-title">${n}</div>`; list.appendChild(div);
                });
                document.getElementById('currentWeekBadge').innerText = "Member";
            
            } else if (viewMode === 'reminder') {
                const div = document.createElement('div'); 
                div.className = 'nav-item active';
                div.innerHTML = `<div class="nav-title">All Reminders</div>`;
                list.appendChild(div);
                document.getElementById('currentWeekBadge').innerText = "Reminders";
            }
        }

        function renderSchedule() {
            const container = document.getElementById('scheduleContainer'); container.innerHTML = '';
            let filtered;
            
            if (viewMode === 'week') filtered = allEvents.filter(e => e.week == currentWeek && e.type !== 'Reminder');
            else if (viewMode === 'lecturer') filtered = allEvents.filter(e => e.lecturer === currentLecturer);
            else if (viewMode === 'member') {
                const allPres = allEvents.filter(e => e.presenters && e.presenters.length > 0);
                const totalGlobal = allPres.reduce((acc, e) => acc + e.presenters.length, 0);
                filtered = allEvents.filter(e => e.presenters && e.presenters.some(p => p.name === currentMember));
                
                const types = { 'Seminar': 0, 'Case Discussion': 0, 'BST': 0, 'Other': 0 };
                filtered.forEach(e => types[e.type === 'Seminar' || e.type === 'Case Discussion' || e.type === 'BST' ? e.type : 'Other']++);
                const pct = totalGlobal > 0 ? (filtered.length / totalGlobal) * 100 : 0;
                
                container.innerHTML = `
                    <div class="analytics-card">
                        <div class="analytics-header">
                            <div class="chart-wrapper"><div class="pie-chart" style="background: conic-gradient(var(--accent-color) 0% ${pct}%, var(--bg-input) ${pct}% 100%)"><div class="pie-inner">${Math.round(pct)}%</div></div></div>
                            <div class="analytics-info"><h3 style="margin-bottom:0.2rem">${currentMember}</h3><div style="font-size:0.8rem; color:var(--text-muted)">Contribution</div><div style="font-size:0.8rem; font-weight:700">${filtered.length} / ${totalGlobal} Presentations</div></div>
                        </div>
                        <div class="stat-grid">
                            ${Object.entries(types).map(([k, v]) => `<div class="stat-box"><span class="stat-num">${v}</span><span class="stat-label">${k}</span></div>`).join('')}
                        </div>
                    </div>`;
            }
            else if (viewMode === 'reminder') filtered = allEvents.filter(e => e.type === 'Reminder');
            
            if(filtered.length === 0) { 
                const msg = '<div style="text-align:center; padding:4rem; color:var(--text-muted)">No sessions found.</div>';
                if(viewMode === 'member') container.innerHTML += msg; else container.innerHTML = msg;
                if(viewMode === 'week') appendNextWeekButton(container); return; 
            }
            
            const grouped = {}; filtered.forEach(e => { if(!grouped[e.date]) grouped[e.date] = []; grouped[e.date].push(e); });
            Object.keys(grouped).sort().forEach(date => {
                const dayName = new Date(date).toLocaleDateString('en-US',{weekday:'long'});
                const div = document.createElement('div'); div.className = 'day-group'; div.dataset.dayName = dayName;
                let cards = ''; grouped[date].forEach(ev => {
                    const t = ev.time || "TBA";
                    const isTBA = t.includes('TBA') || t.includes('TBC') || ev.venue.includes('TBA') || ev.venue.includes('TBC');
                    cards += `<div class="class-card type-${(ev.type || 'Custom').split(' ')[0]}" onclick="openDetail('${ev.id}')">
                        <div class="time-col"><span class="time-start">${t.split(' ')[0]}</span><span class="time-ampm">${t.split(' ')[1] || ''}</span></div>
                        <div class="info-col"><span class="card-type">${ev.type}</span><div class="card-title">${ev.title}</div><div class="card-meta">${ev.lecturer} â€¢ ${ev.venue}</div>
                        ${isTBA ? '<div class="tbc-alert">âš  Confirmation Needed</div>' : ''}</div></div>`;
                });
                div.innerHTML = `<div class="day-header"><span class="day-name">${dayName}</span><span class="day-date">${date}</span></div>` + cards;
                container.appendChild(div);
            });
            if(viewMode === 'week') appendNextWeekButton(container);
        }

        function appendNextWeekButton(container) {
            if (currentWeek < 8) {
                const div = document.createElement('div'); div.className = 'next-week-container';
                div.innerHTML = `<button class="btn-next-week" onclick="nextWeek()">Load Next Week â†“</button>`;
                container.appendChild(div);
            }
        }
        function nextWeek() { currentWeek++; renderSidebarNav(); renderSchedule(); document.getElementById('scheduleContainer').scrollTop = 0; }

        document.getElementById('scheduleContainer').addEventListener('scroll', () => {
            if (viewMode !== 'week') return;
            const groups = document.querySelectorAll('.day-group');
            for (const group of groups) {
                const rect = group.getBoundingClientRect();
                if (rect.top <= 120 && rect.bottom > 60) { document.getElementById('mainHeaderTitle').innerText = group.dataset.dayName; return; }
            }
        });

        function openDetail(id) {
            toggleSidebar(false); currentDetailId = id; const ev = allEvents.find(e => e.id === id); if(!ev) return;
            document.getElementById('detailType').innerText = ev.type; document.getElementById('detailTitle').innerText = ev.title; document.getElementById('detailTime').innerText = `${ev.time} â€¢ ${ev.date}`; document.getElementById('detailLecturer').innerText = ev.lecturer; document.getElementById('detailVenue').innerText = ev.venue; document.getElementById('detailNotes').innerText = ev.notes || "None";
            const bg = document.getElementById('contactSection'); bg.innerHTML = ''; bg.classList.add('hidden');
            let p = ev.lecturerPhone || lecturerContacts[ev.lecturer];
            if (p) { bg.innerHTML += `<a href="https://wa.me/${p.replace(/[^0-9]/g, '')}" target="_blank" class="btn-whatsapp">WhatsApp Lecturer</a>`; bg.classList.remove('hidden'); }
            const ps = document.getElementById('presenterSection'), pl = document.getElementById('presenterList'); pl.innerHTML = '';
            if (ev.type === "BST" || ev.type === "Case Discussion" || ev.type === "Seminar") {
                ps.classList.remove('hidden'); (ev.presenters || []).forEach((p, idx) => {
                    const tag = document.createElement('div'); tag.className = 'presenter-tag'; tag.innerText = p.name;
                    tag.onclick = () => viewPresenter(idx); pl.appendChild(tag);
                });
            } else { ps.classList.add('hidden'); }
            document.getElementById('detailModal').classList.add('active');
            document.getElementById('editBtn').classList.toggle('hidden', !isAdmin);
        }

        function viewPresenter(idx) {
            currentPresIndex = idx; const p = allEvents.find(e => e.id === currentDetailId).presenters[idx];
            document.getElementById('viewPresName').innerText = p.name; document.getElementById('viewPresCase').innerText = p.caseName || "Reservation Only"; document.getElementById('viewPresDetail').innerText = p.detail || "No details provided.";
            document.getElementById('viewPresenterModal').classList.add('active');
        }

        function openPresentForm() { document.getElementById('editPresenterId').value = ""; document.getElementById('inpPresName').value = ""; document.getElementById('inpPresCase').value = ""; document.getElementById('inpPresDetail').value = ""; document.getElementById('presentFormModal').classList.add('active'); }
        function openEditPresenter() {
            const p = allEvents.find(e => e.id === currentDetailId).presenters[currentPresIndex];
            document.getElementById('editPresenterId').value = p.id; document.getElementById('inpPresName').value = p.name; document.getElementById('inpPresCase').value = p.caseName || ""; document.getElementById('inpPresDetail').value = p.detail || "";
            closeModal('viewPresenterModal'); document.getElementById('presentFormModal').classList.add('active');
        }
        async function submitPresentation() {
            const n = document.getElementById('inpPresName').value, e = document.getElementById('editPresenterId').value; if(!n) return alert("Select name");
            
            // 1. UI Feedback
            const btn = document.querySelector('#presentFormModal .btn-primary');
            const originalText = btn.innerText; btn.innerText = "Saving..."; btn.disabled = true;

            try {
                // 2. Force Session Check
                if (!auth.currentUser) await auth.signInAnonymously();

                let ps = allEvents.find(ev => ev.id === currentDetailId).presenters || [];
                const c = document.getElementById('inpPresCase').value, d = document.getElementById('inpPresDetail').value;
                
                if(e) ps = ps.map(p => p.id === e ? {...p, name:n, caseName:c, detail:d} : p);
                else ps.push({ id: Date.now().toString(), name:n, caseName:c, detail:d });
                
                await scheduleRef.doc(currentDetailId).update({ presenters: ps }); 
                closeModal('presentFormModal');
            } catch (err) {
                alert("Error: " + err.message + "\n\n(Hint: Ensure 'Anonymous' auth is enabled in Firebase Console)");
            } finally {
                btn.innerText = originalText; btn.disabled = false;
            }
        }
        async function deletePresentation() { if(!confirm("Remove?")) return; let ps = allEvents.find(e => e.id === currentDetailId).presenters || []; ps.splice(currentPresIndex, 1); await scheduleRef.doc(currentDetailId).update({ presenters: ps }); closeModal('viewPresenterModal'); }

        // --- NOTIFICATIONS ---
        function toggleNotifications() {
            if (!isNotifyEnabled) {
                Notification.requestPermission().then(p => { if (p === "granted") { isNotifyEnabled = true; localStorage.setItem('notifications', 'true'); updateNotifyUI(); } });
            } else { isNotifyEnabled = false; localStorage.setItem('notifications', 'false'); updateNotifyUI(); }
        }
        function updateNotifyUI() { const b = document.getElementById('notifyBtn'); b.innerText = isNotifyEnabled ? "ðŸ”” Reminders: On" : "ðŸ”• Reminders: Off"; b.style.color = isNotifyEnabled ? "var(--accent-color)" : "var(--text-muted)"; }
        setInterval(() => {
            if (!isNotifyEnabled) return; const now = new Date(), today = now.toISOString().split('T')[0], cur = now.getHours()*60 + now.getMinutes();
            allEvents.filter(e => e.date === today).forEach(ev => {
                if (!ev.time || ev.time === "TBA") return; const start = getMinutes(ev.time.split(' - ')[0]), diff = start - cur;
                if (diff > 0 && diff <= 15) { const key = `n_${ev.id}`; if (!localStorage.getItem(key)) { new Notification(`Upcoming: ${ev.title}`, { body: `Starts at ${ev.time.split(' - ')[0]}` }); localStorage.setItem(key, 'true'); } }
            });
        }, 60000);

        // --- ADMIN ---
        function adminLogin() {
            if (isAdmin) {
                // If currently admin, log out
                auth.signOut().then(() => alert("Logged out successfully."));
            } else {
                // Trigger Google Sign In
                auth.signInWithPopup(googleProvider).catch((error) => {
                    console.error("Login failed", error);
                    alert("Login failed: " + error.message);
                });
            }
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); if(id==='detailModal') currentDetailId=null; }
        function toggleTheme() { const n = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme', n); localStorage.setItem('theme',n); }
        function convertTo12Hour(t) { let [h, m] = t.split(':'); const a = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12; return `${h}:${m} ${a}`; }
        function getMinutes(s) { if(!s) return 9999; const p = s.split(' '); let [h, m] = p[0].split(':').map(Number); if(p[1]==='PM'&&h!==12) h+=12; if(p[1]==='AM'&&h===12) h=0; return (h*60)+m; }
        function convertTo24Hour(s) { if(!s || s === "TBA") return ""; const p = s.split(' '); if (p.length < 2) return s; let [h, m] = p[0].split(':'); if (h === '12' && p[1] === 'AM') h = '00'; if (p[1] === 'PM' && h !== '12') h = parseInt(h, 10) + 12; return `${String(h).padStart(2, '0')}:${m}`; }

        function openEditModal(isEdit = false) {
            const sel = document.getElementById('inpLecturerSelect'); sel.innerHTML = '<option value="">Select Lecturer...</option>'; lecturers.forEach(l => sel.innerHTML += `<option value="${l}">${l}</option>`);
            if(isEdit) {
                const ev = allEvents.find(e => e.id === currentDetailId);
                document.getElementById('editId').value = ev.id; document.getElementById('inpType').value = ev.type || "Lecture"; toggleTimeInputs(); document.getElementById('inpTitle').value = ev.title; document.getElementById('inpDate').value = ev.date; document.getElementById('inpVenue').value = ev.venue; document.getElementById('inpNotes').value = ev.notes || ""; document.getElementById('inpWeek').value = ev.week; document.getElementById('inpLecturerPhone').value = ev.lecturerPhone || "";
                sel.value = lecturerContacts.hasOwnProperty(ev.lecturer) ? ev.lecturer : "Other"; document.getElementById('divOtherLecturer').classList.toggle('hidden', sel.value !== "Other"); if(sel.value === "Other") document.getElementById('inpLecturerText').value = ev.lecturer; document.getElementById('btnDelete').classList.remove('hidden');
                if(ev.time && ev.time !== "TBA") { const times = ev.time.split(' - '); document.getElementById('inpStartTime').value = convertTo24Hour(times[0]); document.getElementById('inpEndTime').value = convertTo24Hour(times[1]); }
            } else { document.getElementById('editId').value = ""; document.getElementById('inpDate').value = new Date().toISOString().split('T')[0]; document.getElementById('btnDelete').classList.add('hidden'); document.getElementById('inpWeek').value = currentWeek; }
            closeModal('detailModal'); document.getElementById('editModal').classList.add('active');
        }
        function editCurrentClass() { openEditModal(true); }
        function checkLecturerSelect() { document.getElementById('divOtherLecturer').classList.toggle('hidden', document.getElementById('inpLecturerSelect').value !== "Other"); }
        async function saveClass() {
            // 1. UI Feedback: Disable button to prevent double-clicks and show status
            const saveBtn = document.querySelector('#editModal .btn-primary');
            const originalText = saveBtn.innerText;
            saveBtn.innerText = "Saving...";
            saveBtn.disabled = true;

            try {
                const id = document.getElementById('editId').value;
                let l = document.getElementById('inpLecturerSelect').value;
                if(l === "Other") l = document.getElementById('inpLecturerText').value || "TBA";

                const s = document.getElementById('inpStartTime').value;
                const e = document.getElementById('inpEndTime').value;
                
                // Logic to handle time formatting safely
                let f = "TBA";
                if (s && e) {
                    f = `${convertTo12Hour(s)} - ${convertTo12Hour(e)}`;
                } else if (document.getElementById('inpType').value === "Reminder") {
                    f = "All Day"; // Or keep as TBA
                }

                // 2. Prepare Data with strict parsing for Week
                const data = { 
                    title: document.getElementById('inpTitle').value || "Untitled",
                    lecturer: l, 
                    lecturerPhone: document.getElementById('inpLecturerPhone').value, 
                    date: document.getElementById('inpDate').value, 
                    time: f, 
                    venue: document.getElementById('inpVenue').value || "TBA", 
                    type: document.getElementById('inpType').value, 
                    week: parseInt(document.getElementById('inpWeek').value) || currentWeek, // Ensure Number type
                    notes: document.getElementById('inpNotes').value 
                };

                // 3. Send to Firebase
                if(id) await scheduleRef.doc(id).update(data); 
                else await scheduleRef.add(data);
                
                closeModal('editModal');

            } catch (error) {
                console.error("Error saving class:", error);
                alert("Failed to save: " + error.message); // Alert user if something goes wrong
            } finally {
                // 4. Restore button state
                saveBtn.innerText = originalText;
                saveBtn.disabled = false;
            }
        }
        async function deleteClass() { if(confirm("Delete?")) { await scheduleRef.doc(document.getElementById('editId').value).delete(); closeModal('editModal'); } }

        currentWeek = calculateCurrentWeek(); updateNotifyUI(); renderSidebarNav(); renderSchedule();
    </script>
</body>
</html>
