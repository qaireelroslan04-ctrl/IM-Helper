<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group B Timetable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Force hide utility */
        .force-hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen font-sans text-gray-100">

    <nav class="bg-blue-900 border-b border-blue-800 shadow-lg sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="font-bold text-lg text-white">Group B Timetable</h1>
                <p class="text-xs text-blue-300">Rotation 2 • Medicine I</p>
            </div>
            <div id="statusIndicator" class="text-xs bg-black bg-opacity-30 px-3 py-1 rounded-full flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse" id="statusDot"></div> 
                <span id="statusText">Connecting...</span>
            </div>
        </div>
    </nav>

    <div class="bg-gray-800 shadow-md sticky top-16 z-40 overflow-x-auto border-b border-gray-700">
        <div class="max-w-md mx-auto flex gap-2 p-3" id="weekFilterContainer">
            </div>
    </div>

    <main class="max-w-md mx-auto p-4 pb-24">
        <div id="loading" class="flex flex-col items-center mt-20 text-gray-400">
            <div class="loader mb-4"></div>
            <p>Fetching schedule...</p>
        </div>
        
        <div id="scheduleContainer" class="space-y-4 hidden">
            </div>
    </main>

    <button id="addEventBtn" onclick="openModal()" class="hidden fixed bottom-24 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-2xl hover:bg-blue-500 transition z-50 flex items-center justify-center text-xl">
        <i class="fas fa-plus"></i>
    </button>

    <footer class="max-w-md mx-auto text-center py-6 text-gray-500 text-xs fixed bottom-0 w-full bg-gray-900 border-t border-gray-800">
        <p id="modeDisplay" class="mb-2">Student View</p>
        <div class="flex justify-center gap-4">
            <button onclick="toggleAdmin()" class="text-blue-400 underline">Admin Login</button>
            <button id="resetBtn" onclick="forceReset()" class="hidden text-red-400 underline">Repair Database</button>
        </div>
    </footer>

    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 px-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-xl w-full max-w-sm p-6 shadow-2xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-white" id="modalTitle">Edit Session</h2>
            
            <input type="hidden" id="editId">
            
            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Session Title</label>
            <input type="text" id="editTitle" class="w-full bg-gray-700 border border-gray-600 text-white p-2 rounded mb-3 focus:outline-none focus:border-blue-500">

            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Lecturer</label>
            <input type="text" id="editLecturer" class="w-full bg-gray-700 border border-gray-600 text-white p-2 rounded mb-3 focus:outline-none focus:border-blue-500">

            <div class="flex gap-2 mb-3">
                <div class="w-1/2">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Date</label>
                    <input type="date" id="editDate" class="w-full bg-gray-700 border border-gray-600 text-white p-2 rounded focus:outline-none focus:border-blue-500">
                </div>
                <div class="w-1/2">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Time</label>
                    <input type="text" id="editTime" class="w-full bg-gray-700 border border-gray-600 text-white p-2 rounded focus:outline-none focus:border-blue-500">
                </div>
            </div>

            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Venue</label>
            <input type="text" id="editVenue" class="w-full bg-gray-700 border border-gray-600 text-white p-2 rounded mb-3 focus:outline-none focus:border-blue-500">

            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Week</label>
            <select id="editWeek" class="w-full bg-gray-700 border border-gray-600 text-white p-2 rounded mb-6 focus:outline-none focus:border-blue-500">
                <option value="1">Week 1</option>
                <option value="2">Week 2</option>
                <option value="3">Week 3</option>
                <option value="4">Week 4</option>
                <option value="5">Week 5</option>
                <option value="6">Week 6</option>
                <option value="7">Week 7</option>
                <option value="8">Week 8</option>
            </select>

            <div class="flex justify-between gap-3">
                <button onclick="closeModal()" class="flex-1 text-gray-300 py-2 rounded border border-gray-600 hover:bg-gray-700">Cancel</button>
                <button onclick="saveSession()" class="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-500 font-bold">Save</button>
            </div>
            
            <button id="deleteBtn" onclick="deleteSession()" class="hidden w-full mt-4 text-red-400 text-xs py-2 hover:text-red-300">Delete Session</button>
        </div>
    </div>

    <script>
        // 1. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBd9E9VkE7bllIN13NYGz801F4Jue_VzVk",
            authDomain: "im-helper-d3a4a.firebaseapp.com",
            projectId: "im-helper-d3a4a",
            storageBucket: "im-helper-d3a4a.firebasestorage.app",
            messagingSenderId: "772636018512",
            appId: "1:772636018512:web:b14c28259606e18d6f4e55",
            measurementId: "G-N0F30M6Q5Y"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const scheduleRef = db.collection("schedule_group_b");

        let currentWeek = 1;
        let isAdmin = false;
        let allEvents = [];

        // 2. DATA
        const seedData = [
            // WEEK 1
            { title: "Briefing & Intro", lecturer: "Dr Affizal", date: "2025-12-22", time: "09:00 AM", venue: "Online", week: 1, type: "Lecture" },
            { title: "Gastro Intro", lecturer: "Dr Affizal", date: "2025-12-22", time: "TBC (AM)", venue: "Online", week: 1, type: "Lecture" },
            { title: "Cardio Intro", lecturer: "AP Dr Ling HS", date: "2025-12-22", time: "TBC (PM)", venue: "Online", week: 1, type: "Lecture" },
            { title: "Endocrine Intro", lecturer: "AP Dr Loh HH", date: "2025-12-23", time: "TBC (AM)", venue: "Online", week: 1, type: "Lecture" },
            { title: "Respiratory Intro", lecturer: "AP Dr Chai CS", date: "2025-12-23", time: "TBC (PM)", venue: "Online", week: 1, type: "Lecture" },
            { title: "Neurology Intro", lecturer: "AP Dr Sim CY", date: "2025-12-26", time: "TBC (AM)", venue: "Online", week: 1, type: "Lecture" },
            // WEEK 2
            { title: "Cardio Lecture (LHS 2)", lecturer: "AP Dr Ling HS", date: "2025-12-29", time: "08:00 AM", venue: "TBC", week: 2, type: "Lecture" },
            { title: "BST (PJS) Session", lecturer: "AP Dr Ling HS (B LHS 4)", date: "2025-12-29", time: "TBC (AM)", venue: "PJS", week: 2, type: "BST" },
            { title: "BST (SGH) Session", lecturer: "Prof Dr Henry G (B HG 1)", date: "2025-12-30", time: "TBC (AM)", venue: "SGH", week: 2, type: "BST" },
            { title: "Combined BST (PJS)", lecturer: "Dr Chow HB (AB CHB 2)", date: "2026-01-02", time: "TBC (AM)", venue: "PJS", week: 2, type: "BST" },
            { title: "Resp Seminar", lecturer: "AP Dr Chai CS", date: "2026-01-02", time: "TBC (AM)", venue: "TBC", week: 2, type: "Seminar" },
            { title: "Resp Lecture", lecturer: "AP Dr Chai CS", date: "2026-01-02", time: "TBC (PM)", venue: "TBC", week: 2, type: "Lecture" },
            // WEEK 3
            { title: "BST (PJS)", lecturer: "AP Dr Loh HH (B LHH 3)", date: "2026-01-05", time: "TBC (AM)", venue: "PJS", week: 3, type: "BST" },
            { title: "Case Discussion", lecturer: "Dr Chan EZ (AB CEZ 2)", date: "2026-01-05", time: "TBC (PM)", venue: "TBC", week: 3, type: "CD" },
            { title: "BST (SGH)", lecturer: "AP Dr Loh HH (B LHH 3)", date: "2026-01-06", time: "TBC (AM)", venue: "SGH", week: 3, type: "BST" },
            { title: "Gastro Lecture", lecturer: "Dr Affizal (AF 3)", date: "2026-01-06", time: "TBC (PM)", venue: "TBC", week: 3, type: "Lecture" },
            { title: "BST (SGH)", lecturer: "Dr Joshua (B JOSHUA 2)", date: "2026-01-07", time: "TBC (AM)", venue: "SGH", week: 3, type: "BST" },
            { title: "Gastro Seminar", lecturer: "Dr Affizal (AF 4)", date: "2026-01-07", time: "TBC (PM)", venue: "TBC", week: 3, type: "Seminar" },
            { title: "BST (PJS)", lecturer: "Dr Yeoh CW (B YEOH 1)", date: "2026-01-08", time: "TBC (AM)", venue: "PJS", week: 3, type: "BST" },
            { title: "Inf. Disease Lecture", lecturer: "AP Dr Diana Ng", date: "2026-01-08", time: "TBC (PM)", venue: "TBC", week: 3, type: "Lecture" },
            { title: "Combined Case Disc", lecturer: "Dr Affizal (BE AF 5)", date: "2026-01-09", time: "TBC (PM)", venue: "TBC", week: 3, type: "CD" }
        ];

        // 3. LOGIC
        scheduleRef.orderBy("date").orderBy("time").onSnapshot((snapshot) => {
            document.getElementById('statusDot').classList.replace('bg-yellow-400', 'bg-green-400');
            document.getElementById('statusText').innerText = "Live";
            document.getElementById('statusDot').classList.remove('animate-pulse');

            allEvents = [];
            snapshot.forEach((doc) => {
                allEvents.push({ id: doc.id, ...doc.data() });
            });
            
            renderSchedule();
        }, (error) => {
            console.error(error);
            document.getElementById('statusDot').classList.replace('bg-yellow-400', 'bg-red-500');
            document.getElementById('statusText').innerText = "Permission Error";
        });

        function renderSchedule() {
            const container = document.getElementById('scheduleContainer');
            const loader = document.getElementById('loading');
            
            loader.classList.add('force-hidden');
            container.classList.remove('hidden');
            container.innerHTML = '';

            const weekEvents = allEvents.filter(e => e.week == currentWeek);

            if (weekEvents.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 mt-10 p-6 bg-gray-800 rounded-lg">
                        <i class="fas fa-calendar-times text-4xl mb-3 text-gray-600"></i>
                        <p>No classes found for Week ${currentWeek}.</p>
                        ${isAdmin ? '<p class="text-xs text-blue-400 mt-2">Tap "Repair Database" below to upload defaults.</p>' : ''}
                    </div>`;
                return;
            }

            const grouped = {};
            weekEvents.forEach(event => {
                if (!grouped[event.date]) grouped[event.date] = [];
                grouped[event.date].push(event);
            });

            Object.keys(grouped).sort().forEach(date => {
                const dateObj = new Date(date);
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                
                container.innerHTML += `<div class="font-bold text-blue-400 text-sm mt-6 mb-2 uppercase tracking-wider">${dayName}</div>`;

                grouped[date].forEach(event => {
                    const isPending = event.time.includes("TBC") || event.venue === "N/A" || event.venue === "TBC";
                    const statusClass = isPending ? "border-l-4 border-yellow-500 bg-gray-800" : "border-l-4 border-green-500 bg-gray-800";
                    
                    const html = `
                        <div class="relative p-4 rounded-r-lg shadow-lg ${statusClass} mb-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition" onclick="handleCardClick('${event.id}')">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded ${getTypeColor(event.type)} text-white">${event.type}</span>
                                    ${isPending ? '<span class="text-[10px] text-yellow-500 font-bold border border-yellow-500 px-1 rounded">ACTION REQ</span>' : ''}
                                </div>
                                <h3 class="font-bold text-white text-lg leading-tight mb-1">${event.title}</h3>
                                <p class="text-sm text-gray-400 italic mb-3">${event.lecturer}</p>
                                <div class="flex items-center gap-4 text-sm text-gray-300">
                                    <div class="flex items-center gap-2 bg-gray-900 px-2 py-1 rounded"><i class="far fa-clock text-blue-400"></i> ${event.time}</div>
                                    <div class="flex items-center gap-2 bg-gray-900 px-2 py-1 rounded"><i class="fas fa-map-marker-alt text-red-400"></i> ${event.venue}</div>
                                </div>
                            </div>
                            ${isAdmin ? '<div class="text-gray-500"><i class="fas fa-chevron-right"></i></div>' : ''}
                        </div>
                    `;
                    container.innerHTML += html;
                });
            });
        }

        function getTypeColor(type) {
            if(type === 'BST') return 'bg-purple-600';
            if(type === 'Lecture') return 'bg-blue-600';
            if(type === 'Seminar') return 'bg-orange-600';
            return 'bg-gray-600';
        }

        // 4. ADMIN & RESET
        function toggleAdmin() {
            if (isAdmin) {
                isAdmin = false;
                document.getElementById('modeDisplay').innerText = "Student View";
                document.getElementById('addEventBtn').classList.add('hidden');
                document.getElementById('resetBtn').classList.add('hidden');
                document.querySelector('footer button').innerText = "Admin Login";
                renderSchedule();
            } else {
                const pass = prompt("Passcode:");
                if (pass === "admin123") {
                    isAdmin = true;
                    document.getElementById('modeDisplay').innerText = "Admin Mode";
                    document.getElementById('addEventBtn').classList.remove('hidden');
                    document.getElementById('resetBtn').classList.remove('hidden');
                    document.querySelector('footer button').innerText = "Logout";
                    renderSchedule();
                } else { alert("Wrong passcode"); }
            }
        }

        async function forceReset() {
            if(!confirm("⚠️ This will upload the default schedule to the database. Only do this if the list is empty! Continue?")) return;
            
            const batch = db.batch();
            seedData.forEach((docData) => {
                const newRef = scheduleRef.doc();
                batch.set(newRef, docData);
            });
            
            try {
                await batch.commit();
                alert("Success! Database repaired.");
            } catch (e) {
                alert("Error: " + e.message + "\n\nCHECK FIRESTORE RULES!");
            }
        }

        // 5. MODAL LOGIC
        function handleCardClick(id) {
            if (!isAdmin) return;
            const event = allEvents.find(e => e.id === id);
            openModal(event);
        }

        function openModal(event = null) {
            document.getElementById('editModal').classList.remove('hidden');
            if (event) {
                document.getElementById('modalTitle').innerText = "Edit Session";
                document.getElementById('editId').value = event.id;
                document.getElementById('editTitle').value = event.title;
                document.getElementById('editLecturer').value = event.lecturer;
                document.getElementById('editDate').value = event.date;
                document.getElementById('editTime').value = event.time;
                document.getElementById('editVenue').value = event.venue;
                document.getElementById('editWeek').value = event.week;
                document.getElementById('deleteBtn').classList.remove('hidden');
            } else {
                document.getElementById('modalTitle').innerText = "New Session";
                document.getElementById('editId').value = "";
                document.getElementById('editTitle').value = "";
                document.getElementById('editLecturer').value = "";
                document.getElementById('editDate').value = "";
                document.getElementById('editTime').value = "TBC";
                document.getElementById('editVenue').value = "TBC";
                document.getElementById('editWeek').value = currentWeek;
                document.getElementById('deleteBtn').classList.add('hidden');
            }
        }

        function closeModal() { document.getElementById('editModal').classList.add('hidden'); }

        function saveSession() {
            const id = document.getElementById('editId').value;
            const data = {
                title: document.getElementById('editTitle').value,
                lecturer: document.getElementById('editLecturer').value,
                date: document.getElementById('editDate').value,
                time: document.getElementById('editTime').value,
                venue: document.getElementById('editVenue').value,
                week: document.getElementById('editWeek').value,
                type: "Custom"
            };

            if (id) {
                scheduleRef.doc(id).update(data).then(closeModal);
            } else {
                scheduleRef.add(data).then(closeModal);
            }
        }

        function deleteSession() {
            const id = document.getElementById('editId').value;
            if(confirm("Delete this session?")) {
                scheduleRef.doc(id).delete().then(closeModal);
            }
        }

        // 6. TABS
        const weekContainer = document.getElementById('weekFilterContainer');
        for (let i = 1; i <= 8; i++) {
            const btn = document.createElement('button');
            btn.innerText = `Week ${i}`;
            btn.className = `flex-shrink-0 px-4 py-2 rounded-lg text-sm font-bold transition ${i === 1 ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-400'}`;
            btn.onclick = () => setWeek(i, btn);
            weekContainer.appendChild(btn);
        }

        function setWeek(week, btnElement) {
            currentWeek = week;
            renderSchedule();
            Array.from(weekContainer.children).forEach(b => {
                b.className = 'flex-shrink-0 px-4 py-2 rounded-lg text-sm font-bold bg-gray-700 text-gray-400';
            });
            btnElement.className = 'flex-shrink-0 px-4 py-2 rounded-lg text-sm font-bold bg-blue-600 text-white';
        }
    </script>
</body>
</html>
